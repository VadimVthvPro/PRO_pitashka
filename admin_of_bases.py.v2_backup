import tkinter as tk
from tkinter import ttk, messagebox, Spinbox, Frame, Canvas, Scrollbar
import psycopg2
from datetime import datetime
import sys
import os
import bcrypt

# Add parent directory to path to import config
sys.path.insert(0, os.path.dirname(__file__))
from config import config

# ============================================
# –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –®–†–ò–§–¢–û–í (–£–í–ï–õ–ò–ß–ï–ù–´)
# ============================================
FONT_LARGE = ("Arial", 14, "bold")      # –ó–∞–≥–æ–ª–æ–≤–∫–∏
FONT_MEDIUM = ("Arial", 13)             # –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
FONT_SMALL = ("Arial", 12)              # –ú–µ–ª–∫–∏–π —Ç–µ–∫—Å—Ç
FONT_TABLE_HEADER = ("Arial", 12, "bold")  # –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü
FONT_TABLE_CELL = ("Arial", 11)         # –Ø—á–µ–π–∫–∏ —Ç–∞–±–ª–∏—Ü
ROW_HEIGHT = 30                          # –í—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ

def center_window(window, width, height):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ."""
    screen_width = window.winfo_screenwidth()
    screen_height = window.winfo_screenheight()
    x = (screen_width // 2) - (width // 2)
    y = (screen_height // 2) - (height // 2)
    window.geometry(f"{width}x{height}+{x}+{y}")

def get_db_connection():
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (—Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)."""
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ .env —Ñ–∞–π–ª–∞
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º admin credentials, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–µ
        db_config = config.get_db_config(admin=True)
        
        # –ï—Å–ª–∏ ADMIN_DB_PASSWORD –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–µ credentials
        if not db_config.get('password'):
            db_config = config.get_db_config(admin=False)
        
        conn = psycopg2.connect(**db_config)
        return conn
    except psycopg2.Error as e:
        messagebox.showerror("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è", f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return None

def get_all_tables():
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    conn = get_db_connection()
    if not conn:
        return []
    
    try:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            AND table_type = 'BASE TABLE'
            ORDER BY table_name;
        """)
        tables = [row[0] for row in cursor.fetchall()]
        cursor.close()
        conn.close()
        return tables
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–∞–±–ª–∏—Ü: {e}")
        return []

def get_table_columns(table_name):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—ã."""
    conn = get_db_connection()
    if not conn:
        return []
    
    try:
        cursor = conn.cursor()
        cursor.execute(f"""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name = '{table_name}'
            ORDER BY ordinal_position;
        """)
        columns = [row[0] for row in cursor.fetchall()]
        cursor.close()
        conn.close()
        return columns
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è {table_name}: {e}")
        return []

def get_primary_key(table_name):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ —Ç–∞–±–ª–∏—Ü—ã."""
    conn = get_db_connection()
    if not conn:
        return "id"
    
    try:
        cursor = conn.cursor()
        cursor.execute(f"""
            SELECT a.attname
            FROM pg_index i
            JOIN pg_attribute a ON a.attrelid = i.indrelid AND a.attnum = ANY(i.indkey)
            WHERE i.indrelid = '{table_name}'::regclass
            AND i.indisprimary
            LIMIT 1;
        """)
        result = cursor.fetchone()
        cursor.close()
        conn.close()
        return result[0] if result else "id"
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –¥–ª—è {table_name}: {e}")
        return "id"

class ScrollableNotebook(ttk.Frame):
    """–í–∏–¥–∂–µ—Ç Notebook —Å –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã–º–∏ –≤–∫–ª–∞–¥–∫–∞–º–∏"""
    def __init__(self, parent, *args, **kwargs):
        ttk.Frame.__init__(self, parent, *args, **kwargs)
        
        # –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–∫–ª–∞–¥–æ–∫
        self.canvas = Canvas(self, height=40, highlightthickness=0)
        self.canvas.pack(side="top", fill="x", expand=False)
        
        # –§—Ä–µ–π–º –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∫–ª–∞–¥–æ–∫
        self.tab_frame = ttk.Frame(self.canvas)
        self.canvas_frame = self.canvas.create_window((0, 0), window=self.tab_frame, anchor="nw")
        
        # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
        self.h_scroll = ttk.Scrollbar(self, orient="horizontal", command=self.canvas.xview)
        self.h_scroll.pack(side="top", fill="x")
        self.canvas.configure(xscrollcommand=self.h_scroll.set)
        
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤–∫–ª–∞–¥–æ–∫
        self.content_frame = ttk.Frame(self)
        self.content_frame.pack(side="top", fill="both", expand=True)
        
        self.tabs = []
        self.tab_buttons = []
        self.current_tab = None
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        self.tab_frame.bind("<Configure>", self._on_frame_configure)
        
    def _on_frame_configure(self, event=None):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ canvas"""
        self.canvas.configure(scrollregion=self.canvas.bbox("all"))
        
    def add(self, child, text=""):
        """–î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É"""
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
        btn = ttk.Button(
            self.tab_frame, 
            text=text, 
            command=lambda idx=len(self.tabs): self.select_tab(idx),
            width=max(15, len(text))
        )
        btn.pack(side="left", padx=3, pady=5)
        
        self.tab_buttons.append(btn)
        self.tabs.append((child, text))
        
        # –ü—Ä—è—á–µ–º child –≤ content_frame
        child.place(in_=self.content_frame, x=0, y=0, relwidth=1, relheight=1)
        child.lower()
        
        # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –≤–∫–ª–∞–¥–∫–∞, –≤—ã–±–∏—Ä–∞–µ–º –µ—ë
        if len(self.tabs) == 1:
            self.select_tab(0)
            
    def select_tab(self, index):
        """–í—ã–±—Ä–∞—Ç—å –≤–∫–ª–∞–¥–∫—É –ø–æ –∏–Ω–¥–µ–∫—Å—É"""
        if 0 <= index < len(self.tabs):
            # –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            for btn in self.tab_buttons:
                btn.state(["!pressed", "!active"])
            
            # –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–Ω–æ–ø–∫—É
            self.tab_buttons[index].state(["pressed"])
            
            # –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            for tab, _ in self.tabs:
                tab.lower()
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            self.tabs[index][0].lift()
            self.current_tab = index

class Application:
    def __init__(self, root):
        self.root = root
        
        # –ü–†–ï–î–û–ü–†–ï–î–ï–õ–Å–ù–ù–´–ï –¢–ê–ë–õ–ò–¶–´ –° –≠–ú–û–î–ó–ò –ò –ö–†–ê–°–ò–í–´–ú–ò –ù–ê–ó–í–ê–ù–ò–Ø–ú–ò
        self.predefined_tables = {
            "user_main": "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            "food": "üçΩÔ∏è –ü–∏—Ç–∞–Ω–∏–µ",
            "user_aims": "üéØ –¶–µ–ª–∏",
            "user_health": "üí™ –ó–¥–æ—Ä–æ–≤—å–µ",
            "user_lang": "üåê –Ø–∑—ã–∫–∏",
            "user_training": "üèÉ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
            "water": "üíß –í–æ–¥–∞",
            "training_types": "üèãÔ∏è –¢–∏–ø—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫",
            "training_coefficients": "üìä –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã",
            "chat_history": "üí¨ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞",
            "admin_users": "üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"
        }
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
        self.column_mapping = {
            # user_main
            "user_id": "ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            "user_name": "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            "user_sex": "–ü–æ–ª",
            "date_of_birth": "–í–æ–∑—Ä–∞—Å—Ç",
            
            # food
            "food_id": "ID –∑–∞–ø–∏—Å–∏",
            "id": "ID",
            "name_of_food": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞",
            "b": "–ë–µ–ª–∫–∏ (–≥)",
            "g": "–ñ–∏—Ä—ã (–≥)",
            "u": "–£–≥–ª–µ–≤–æ–¥—ã (–≥)",
            "cal": "–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å",
            "date": "–î–∞—Ç–∞",
            
            # user_aims
            "aim_id": "ID —Ü–µ–ª–∏",
            "user_aim": "–¶–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            "daily_cal": "–î–Ω–µ–≤–Ω–∞—è –Ω–æ—Ä–º–∞ (–∫–∫–∞–ª)",
            
            # user_health
            "health_id": "ID –∑–∞–ø–∏—Å–∏",
            "imt": "–ò–ú–¢",
            "imt_str": "–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ò–ú–¢",
            "weight": "–í–µ—Å (–∫–≥)",
            "height": "–†–æ—Å—Ç (—Å–º)",
            
            # user_lang
            "lang": "–Ø–∑—ã–∫",
            
            # user_training
            "training_id": "ID —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
            "training_cal": "–°–æ–∂–∂–µ–Ω–æ –∫–∞–ª–æ—Ä–∏–π",
            "tren_time": "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)",
            "training_type_id": "ID —Ç–∏–ø–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
            "training_name": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
            "updated_at": "–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è",
            
            # water
            "count": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Å—Ç–∞–∫–∞–Ω–æ–≤)",
            "data": "–î–∞—Ç–∞",
            
            # training_types
            "name_ru": "–ù–∞–∑–≤–∞–Ω–∏–µ (RU)",
            "name_en": "–ù–∞–∑–≤–∞–Ω–∏–µ (EN)",
            "name_de": "–ù–∞–∑–≤–∞–Ω–∏–µ (DE)",
            "name_fr": "–ù–∞–∑–≤–∞–Ω–∏–µ (FR)",
            "name_es": "–ù–∞–∑–≤–∞–Ω–∏–µ (ES)",
            "base_coefficient": "–ë–∞–∑–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç",
            "emoji": "–≠–º–æ–¥–∑–∏",
            "description_ru": "–û–ø–∏—Å–∞–Ω–∏–µ (RU)",
            "description_en": "–û–ø–∏—Å–∞–Ω–∏–µ (EN)",
            "description_de": "–û–ø–∏—Å–∞–Ω–∏–µ (DE)",
            "description_fr": "–û–ø–∏—Å–∞–Ω–∏–µ (FR)",
            "description_es": "–û–ø–∏—Å–∞–Ω–∏–µ (ES)",
            "is_active": "–ê–∫—Ç–∏–≤–µ–Ω",
            "created_at": "–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è",
            
            # training_coefficients
            "gender_male_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–º—É–∂—Å–∫–æ–π)",
            "gender_female_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–∂–µ–Ω—Å–∫–∏–π)",
            "age_18_25_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (18-25 –ª–µ—Ç)",
            "age_26_35_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (26-35 –ª–µ—Ç)",
            "age_36_45_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (36-45 –ª–µ—Ç)",
            "age_46_55_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (46-55 –ª–µ—Ç)",
            "age_56_plus_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (56+ –ª–µ—Ç)",
            "weight_under_60_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤–µ—Å <60)",
            "weight_60_70_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤–µ—Å 60-70)",
            "weight_71_80_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤–µ—Å 71-80)",
            "weight_81_90_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤–µ—Å 81-90)",
            "weight_91_100_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤–µ—Å 91-100)",
            "weight_over_100_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤–µ—Å >100)",
            "height_under_160_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (—Ä–æ—Å—Ç <160)",
            "height_160_175_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (—Ä–æ—Å—Ç 160-175)",
            "height_over_175_modifier": "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä (—Ä–æ—Å—Ç >175)",
            
            # chat_history
            "message_type": "–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è",
            "message_text": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
            
            # admin_users
            "username": "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            "password_hash": "–•–µ—à –ø–∞—Ä–æ–ª—è",
            "last_login": "–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥"
        }
        
        self.initialize_ui()

    def initialize_ui(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞."""
        self.frame = ttk.Frame(self.root)
        self.frame.pack(fill="both", expand=True, padx=10, pady=10)
        self.entry()

    def entry(self):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤—Ö–æ–¥–∞."""
        title_label = ttk.Label(self.frame, text="–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É", font=FONT_LARGE)
        title_label.grid(row=0, column=0, columnspan=2, pady=20)
        
        self.label_name = ttk.Label(self.frame, text="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", font=FONT_MEDIUM)
        self.label_name.grid(row=1, column=0, padx=5, pady=10, sticky="w")
        self.entry_name = ttk.Entry(self.frame, width=25, font=FONT_MEDIUM)
        self.entry_name.grid(row=1, column=1, padx=5, pady=10, sticky="ew")

        self.label_pas = ttk.Label(self.frame, text="–ü–∞—Ä–æ–ª—å:", font=FONT_MEDIUM)
        self.label_pas.grid(row=2, column=0, padx=5, pady=10, sticky="w")
        self.entry_pas = ttk.Entry(self.frame, width=25, show="*", font=FONT_MEDIUM)
        self.entry_pas.grid(row=2, column=1, padx=5, pady=10, sticky="ew")

        self.button_frame = ttk.Frame(self.frame)
        self.button_frame.grid(row=3, column=0, columnspan=2, sticky="e", padx=5, pady=15)

        self.button = ttk.Button(self.button_frame, text="–í–æ–π—Ç–∏", command=self.submit, width=12)
        self.button.pack(side="left", padx=5)

        self.cancel_button = ttk.Button(self.button_frame, text="–û—Ç–º–µ–Ω–∞", command=self.close_window, width=12)
        self.cancel_button.pack(side="left", padx=5)

        self.error_label = ttk.Label(self.frame, text="", font=FONT_SMALL)
        self.error_label.grid(row=4, column=0, columnspan=2, sticky="ew")

        self.frame.columnconfigure(1, weight=1)
        
        # Bind Enter key
        self.entry_pas.bind("<Return>", lambda e: self.submit())

    def submit(self):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        username = self.entry_name.get()
        password = self.entry_pas.get()

        if not username or not password:
            self.error_label.config(text="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏", foreground="red")
            return

        conn = get_db_connection()
        if not conn:
            return

        try:
            cursor = conn.cursor()
            cursor.execute("SELECT password_hash FROM admin_users WHERE username = %s", (username,))
            result = cursor.fetchone()

            if result:
                password_hash = result[0]
                if bcrypt.checkpw(password.encode('utf-8'), password_hash.encode('utf-8')):
                    # –ü–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, –æ–±–Ω–æ–≤–ª—è–µ–º last_login
                    cursor.execute("UPDATE admin_users SET last_login = NOW() WHERE username = %s", (username,))
                    conn.commit()
                    self.show_main_window()
                else:
                    self.error_label.config(text="–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å", foreground="red")
            else:
                self.error_label.config(text="–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å", foreground="red")

            cursor.close()
            conn.close()

        except Exception as e:
            self.error_label.config(text=f"–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}", foreground="red")
            print(f"–û—à–∏–±–∫–∞: {str(e)}")
            if conn:
                conn.close()

    def show_main_window(self):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –≤–∫–ª–∞–¥–∫–∞–º–∏."""
        self.frame.pack_forget()
        
        # –ó–ê–ö–†–´–í–ê–ï–ú –°–¢–ê–†–û–ï –û–ö–ù–û –í–•–û–î–ê
        self.root.withdraw()  # –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥–∞
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
        self.main_root = tk.Toplevel(self.root)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º ScrollableNotebook
        self.notebook = ScrollableNotebook(self.main_root)
        self.notebook.pack(fill="both", expand=True)

        # –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ
        window_width = 1600
        window_height = 1000
        center_window(self.main_root, window_width, window_height)
        self.main_root.title("PRO–ø–∏—Ç–∞—à–∫–∞ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
        self.main_root.minsize(1200, 800)
        
        # –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        self.main_root.protocol("WM_DELETE_WINDOW", self.close_all)

        self.create_tabs()

    def create_tabs(self):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ –∏–∑ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –ë–î."""
        all_tables = get_all_tables()
        
        # –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        predefined_order = [
            "user_main", "food", "user_aims", "user_health", "user_lang",
            "user_training", "water", "training_types", "training_coefficients",
            "chat_history", "admin_users"
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
        for table_name in predefined_order:
            if table_name in all_tables:
                tab_name = self.predefined_tables.get(table_name, table_name)
                columns = get_table_columns(table_name)
                if columns:
                    tab = ttk.Frame(self.notebook)
                    self.notebook.add(tab, text=tab_name)
                    self.create_table(tab, columns, table_name)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
        for table_name in all_tables:
            if table_name not in predefined_order:
                columns = get_table_columns(table_name)
                if columns:
                    tab = ttk.Frame(self.notebook)
                    self.notebook.add(tab, text=table_name)  # –ê–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    self.create_table(tab, columns, table_name)

    def create_table(self, tab, columns, table_name):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ."""
        container = ttk.Frame(tab)
        container.grid(row=2, column=0, sticky="nsew")

        # –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        display_columns = [self.column_mapping.get(col, col.replace('_', ' ').title()) for col in columns]
        
        tree = ttk.Treeview(container, columns=columns, show="headings")
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã
        style = ttk.Style()
        style.configure("Treeview.Heading", font=FONT_TABLE_HEADER, padding=8)
        style.configure("Treeview", font=FONT_TABLE_CELL, rowheight=ROW_HEIGHT)

        # –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
        for i, col in enumerate(columns):
            tree.heading(col, text=f"{display_columns[i]} ‚ñº", 
                        command=lambda c=col, t=tree: self.sort_treeview(t, c, False))
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫
            tree.column(col, width=150, minwidth=100, stretch=True)

        # –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–ê–Ø –ò –í–ï–†–¢–ò–ö–ê–õ–¨–ù–ê–Ø –ü–†–û–ö–†–£–¢–ö–ê
        h_scroll = ttk.Scrollbar(container, orient="horizontal", command=tree.xview)
        tree.configure(xscrollcommand=h_scroll.set)
        h_scroll.grid(row=1, column=0, sticky="ew")

        v_scroll = ttk.Scrollbar(container, orient="vertical", command=tree.yview)
        tree.configure(yscrollcommand=v_scroll.set)
        v_scroll.grid(row=0, column=1, sticky="ns")

        tree.grid(row=0, column=0, sticky="nsew")

        container.rowconfigure(0, weight=1)
        container.columnconfigure(0, weight=1)
        tab.rowconfigure(2, weight=1)
        tab.columnconfigure(0, weight=1)

        def load_data():
            try:
                conn = get_db_connection()
                if conn:
                    cursor = conn.cursor()
                    pk = get_primary_key(table_name)
                    query = f"SELECT * FROM {table_name} ORDER BY {pk} DESC LIMIT 1000"
                    cursor.execute(query)
                    rows = cursor.fetchall()

                    for row in tree.get_children():
                        tree.delete(row)

                    for row in rows:
                        tree.insert("", "end", values=row)

                    cursor.close()
                    conn.close()
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: {e}")

        load_data()

        # –§–∏–ª—å—Ç—Ä
        filter_frame = ttk.Frame(tab)
        filter_frame.grid(row=0, column=0, sticky="ew", pady=8, padx=8)

        filter_label = ttk.Label(filter_frame, text="üîç –§–∏–ª—å—Ç—Ä:", font=FONT_MEDIUM)
        filter_label.pack(side="left", padx=5)

        filter_entry = ttk.Entry(filter_frame, width=40, font=FONT_MEDIUM)
        filter_entry.pack(side="left", padx=5, fill="x", expand=True)

        def apply_filter():
            filter_text = filter_entry.get().lower()
            for row in tree.get_children():
                tree.delete(row)

            try:
                conn = get_db_connection()
                if conn:
                    cursor = conn.cursor()
                    cursor.execute(f"SELECT * FROM {table_name}")
                    rows = cursor.fetchall()

                    for row in rows:
                        if any(filter_text in str(cell).lower() for cell in row):
                            tree.insert("", "end", values=row)

                    cursor.close()
                    conn.close()
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä: {e}")

        filter_button = ttk.Button(filter_frame, text="–ò—Å–∫–∞—Ç—å", command=apply_filter)
        filter_button.pack(side="left", padx=5)

        clear_filter_button = ttk.Button(filter_frame, text="–°–±—Ä–æ—Å–∏—Ç—å", command=load_data)
        clear_filter_button.pack(side="left", padx=5)

        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        button_frame = ttk.Frame(tab)
        button_frame.grid(row=1, column=0, sticky="ew", pady=8, padx=8)

        refresh_button = ttk.Button(button_frame, text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", command=load_data)
        refresh_button.pack(side="left", padx=5)

        # –ö–ù–û–ü–ö–ê "–î–û–ë–ê–í–ò–¢–¨ –ó–ê–ü–ò–°–¨" –î–õ–Ø –í–°–ï–• –¢–ê–ë–õ–ò–¶
        add_button = ttk.Button(button_frame, text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å", 
                               command=lambda: self.add_record(tree, columns, table_name, load_data))
        add_button.pack(side="left", padx=5)

        delete_button = ttk.Button(button_frame, text="üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É", 
                                   command=lambda: self.delete_record(tree, table_name, load_data))
        delete_button.pack(side="left", padx=5)

        # –°—á—ë—Ç—á–∏–∫ –∑–∞–ø–∏—Å–µ–π
        count_label = ttk.Label(button_frame, text=f"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(tree.get_children())}", 
                               font=FONT_SMALL)
        count_label.pack(side="right", padx=10)

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        def load_data_with_count():
            load_data()
            count_label.config(text=f"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(tree.get_children())}")

        refresh_button.config(command=load_data_with_count)
        add_button.config(command=lambda: self.add_record(tree, columns, table_name, load_data_with_count))
        delete_button.config(command=lambda: self.delete_record(tree, table_name, load_data_with_count))
        clear_filter_button.config(command=load_data_with_count)

        tree.bind("<Double-1>", lambda event: self.edit_cell(event, tree, columns, table_name, load_data_with_count))

    def sort_treeview(self, tree, col, reverse):
        """–£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
        data = [(tree.set(item, col), item) for item in tree.get_children("")]
        
        # –ü–æ–ø—ã—Ç–∫–∞ —á–∏—Å–ª–æ–≤–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        try:
            data.sort(key=lambda x: float(x[0]) if x[0] and x[0] != 'None' else 0, reverse=reverse)
        except (ValueError, TypeError):
            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏
            data.sort(key=lambda x: str(x[0]).lower(), reverse=reverse)

        for index, (val, item) in enumerate(data):
            tree.move(item, "", index)

        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        current_text = tree.heading(col)['text']
        base_text = current_text.replace(' ‚ñº', '').replace(' ‚ñ≤', '')
        new_text = f"{base_text} {'‚ñ≤' if reverse else '‚ñº'}"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        tree.heading(col, text=new_text, command=lambda: self.sort_treeview(tree, col, not reverse))

    def delete_record(self, tree, table_name, load_data):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ —Å –∫–∞—Å–∫–∞–¥–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º."""
        selected_items = tree.selection()
        if not selected_items:
            messagebox.showwarning("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ", "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
            return

        confirm = messagebox.askyesno("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", 
                                     f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å {len(selected_items)} —Å—Ç—Ä–æ–∫(–∏)?")
        if not confirm:
            return

        try:
            conn = get_db_connection()
            if conn:
                cursor = conn.cursor()
                pk = get_primary_key(table_name)

                for item in selected_items:
                    values = tree.item(item, "values")
                    primary_key_value = values[0]

                    # –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–ª—è user_main
                    if table_name == "user_main":
                        self.delete_related_records(cursor, primary_key_value)

                    cursor.execute(f"DELETE FROM {table_name} WHERE {pk} = %s", (primary_key_value,))

                conn.commit()
                cursor.close()
                conn.close()

                load_data()
                messagebox.showinfo("–£—Å–ø–µ—Ö", f"–£–¥–∞–ª–µ–Ω–æ {len(selected_items)} —Å—Ç—Ä–æ–∫(–∏).")
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏: {e}")
            if conn:
                conn.rollback()

    def delete_related_records(self, cursor, user_id):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π."""
        related_tables = [
            "chat_history", "food", "user_aims", "user_health",
            "user_lang", "user_training", "water"
        ]
        
        for table in related_tables:
            try:
                cursor.execute(f"DELETE FROM {table} WHERE user_id = %s", (user_id,))
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ {table}: {e}")

    def add_record(self, tree, columns, table_name, load_data):
        """–£–õ–£–ß–®–ï–ù–ù–û–ï –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏."""
        add_window = tk.Toplevel()
        add_window.title(f"–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É '{table_name}'")
        
        # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
        window_height = min(len(columns) * 70 + 200, 900)
        window_width = 800
        center_window(add_window, window_width, window_height)
        add_window.minsize(700, 400)

        # Canvas —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª–µ–π
        main_frame = ttk.Frame(add_window)
        main_frame.pack(fill="both", expand=True, padx=10, pady=10)

        canvas = Canvas(main_frame)
        scrollbar = ttk.Scrollbar(main_frame, orient="vertical", command=canvas.yview)
        scrollable_frame = ttk.Frame(canvas)

        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )

        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)

        entries = []
        pk = get_primary_key(table_name)

        for i, col in enumerate(columns):
            label_text = self.column_mapping.get(col, col.replace('_', ' ').title())
            label = ttk.Label(scrollable_frame, text=label_text + ":", font=FONT_MEDIUM)
            label.grid(row=i, column=0, padx=15, pady=10, sticky="e")

            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è (–ø–µ—Ä–≤–∏—á–Ω—ã–µ –∫–ª—é—á–∏, timestamps)
            if col == pk or col in ['created_at', 'updated_at', 'last_login']:
                entry = ttk.Entry(scrollable_frame, width=30, font=FONT_MEDIUM, state="disabled")
                entry.insert(0, "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏")
            elif col in ['date', 'data']:
                entry = ttk.Entry(scrollable_frame, width=30, font=FONT_MEDIUM)
                entry.insert(0, datetime.now().strftime("%Y-%m-%d"))
            else:
                entry = ttk.Entry(scrollable_frame, width=30, font=FONT_MEDIUM)
            
            entry.grid(row=i, column=1, padx=15, pady=10, sticky="w")
            entries.append(entry)

        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")

        def save_record():
            values = []
            for i, entry in enumerate(entries):
                if entry.cget('state') == 'disabled':
                    continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è
                value = entry.get().strip()
                values.append(value if value else None)

            # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–ª–æ–Ω–∫–∏ (–±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö)
            filtered_columns = [col for col in columns if col != pk and col not in ['created_at', 'updated_at', 'last_login']]

            try:
                conn = get_db_connection()
                if conn:
                    cursor = conn.cursor()
                    placeholders = ', '.join(['%s'] * len(filtered_columns))
                    query = f"INSERT INTO {table_name} ({', '.join(filtered_columns)}) VALUES ({placeholders})"
                    cursor.execute(query, values)
                    conn.commit()
                    cursor.close()
                    conn.close()
                    add_window.destroy()
                    load_data()
                    messagebox.showinfo("–£—Å–ø–µ—Ö", "–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!")
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å: {e}")

        button_frame = ttk.Frame(add_window)
        button_frame.pack(side="bottom", fill="x", padx=10, pady=15)

        add_button = ttk.Button(button_frame, text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", command=save_record, width=18)
        add_button.pack(side="left", padx=5)

        cancel_button = ttk.Button(button_frame, text="‚ùå –û—Ç–º–µ–Ω–∞", command=add_window.destroy, width=18)
        cancel_button.pack(side="left", padx=5)

    def edit_cell(self, event, tree, columns, table_name, load_data):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–π–∫–∏ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º –∫–ª–∏–∫–µ."""
        region = tree.identify_region(event.x, event.y)
        if region != "cell":
            return

        if not tree.selection():
            return
            
        item = tree.selection()[0]
        column = tree.identify_column(event.x)
        column_index = int(column.replace("#", "")) - 1
        
        if column_index < 0 or column_index >= len(columns):
            return
            
        column_name = columns[column_index]
        current_value = tree.set(item, column)

        # –ó–∞–ø—Ä–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π
        pk = get_primary_key(table_name)
        if column_name == pk:
            messagebox.showinfo("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å")
            return

        entry_edit = ttk.Entry(tree, font=FONT_TABLE_CELL)
        entry_edit.insert(0, current_value)
        entry_edit.select_range(0, tk.END)
        entry_edit.focus()

        def save_edit(event=None):
            new_value = entry_edit.get().strip()
            if new_value == current_value:
                entry_edit.destroy()
                return

            try:
                conn = get_db_connection()
                if conn:
                    cursor = conn.cursor()
                    primary_key_value = tree.item(item, "values")[0]
                    
                    update_query = f"UPDATE {table_name} SET {column_name} = %s WHERE {pk} = %s"
                    cursor.execute(update_query, (new_value, primary_key_value))
                    conn.commit()
                    cursor.close()
                    conn.close()

                    load_data()
                    entry_edit.destroy()
                    messagebox.showinfo("–£—Å–ø–µ—Ö", "–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!")
            except Exception as e:
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å: {e}")
                entry_edit.destroy()

        entry_edit.bind("<Return>", save_edit)
        entry_edit.bind("<Escape>", lambda e: entry_edit.destroy())
        entry_edit.bind("<FocusOut>", lambda e: entry_edit.destroy())

        try:
            x, y, width, height = tree.bbox(item, column)
            entry_edit.place(x=x, y=y, width=width, height=height)
        except:
            entry_edit.destroy()

    def close_window(self):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞."""
        self.root.destroy()
    
    def close_all(self):
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
        try:
            if hasattr(self, 'main_root'):
                self.main_root.destroy()
            self.root.destroy()
        except:
            pass

# –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
root = tk.Tk()
root.title("PRO–ø–∏—Ç–∞—à–∫–∞ - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è")

# –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞
window_width = 500
window_height = 300
center_window(root, window_width, window_height)
root.minsize(450, 250)

app = Application(root)
root.mainloop()
