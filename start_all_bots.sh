#!/bin/bash
# ============================================
# –°–ö–†–ò–ü–¢ –ó–ê–ü–£–°–ö–ê –í–°–ï–• –ë–û–¢–û–í PROPITASHKA
# ============================================
# –ê–≤—Ç–æ—Ä: AI Assistant
# –î–∞—Ç–∞: 2025-10-31

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã PROpitashka..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")"

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source ./bin/activate

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ ! -f "main.py" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: main.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

if [ ! -f "referral_bot.py" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: referral_bot.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

if [ ! -f "ad_bot.py" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: ad_bot.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –ë–î (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞)
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
if [ -f "migrations/006_referral_system.sql" ]; then
    echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 006_referral_system.sql..."
    # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
    # psql -U your_user -d your_db -f migrations/006_referral_system.sql
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -9 -f "python3 main.py" 2>/dev/null || true
pkill -9 -f "python3 referral_bot.py" 2>/dev/null || true
pkill -9 -f "python3 ad_bot.py" 2>/dev/null || true

sleep 2

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p logs

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç
echo "ü§ñ –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞ (PROpitashka)..."
nohup ./bin/python3 main.py > logs/main_bot.log 2>&1 &
MAIN_PID=$!
echo "   PID: $MAIN_PID"

sleep 2

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ—Ç
echo "üéÅ –ó–∞–ø—É—Å–∫ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞..."
nohup ./bin/python3 referral_bot.py > logs/referral_bot.log 2>&1 &
REF_PID=$!
echo "   PID: $REF_PID"

sleep 2

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–æ—Ç
echo "üì¢ –ó–∞–ø—É—Å–∫ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –±–æ—Ç–∞..."
nohup ./bin/python3 ad_bot.py > logs/ad_bot.log 2>&1 &
AD_PID=$!
echo "   PID: $AD_PID"

sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–ø—É—â–µ–Ω—ã
echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."

if ps -p $MAIN_PID > /dev/null; then
    echo "   ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $MAIN_PID)"
else
    echo "   ‚ùå –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
fi

if ps -p $REF_PID > /dev/null; then
    echo "   ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $REF_PID)"
else
    echo "   ‚ùå –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
fi

if ps -p $AD_PID > /dev/null; then
    echo "   ‚úÖ –†–µ–∫–ª–∞–º–Ω—ã–π –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $AD_PID)"
else
    echo "   ‚ùå –†–µ–∫–ª–∞–º–Ω—ã–π –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
fi

echo ""
echo "üéâ –í—Å–µ –±–æ—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo ""
echo "üìä –õ–æ–≥–∏:"
echo "   –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç: logs/main_bot.log"
echo "   –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ—Ç: logs/referral_bot.log"
echo "   –†–µ–∫–ª–∞–º–Ω—ã–π –±–æ—Ç: logs/ad_bot.log"
echo ""
echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –±–æ—Ç–æ–≤: ./stop_all_bots.sh"
echo ""


