# 🗺️ Архитектурная схема календаря выбора даты

## Поток данных

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           ПОЛЬЗОВАТЕЛЬ                                    │
│                    Вводит рост в Telegram                                 │
└────────────────────────────────┬─────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER (main.py)                           │
│                                                                           │
│  @dp.message(REG.height)                                                  │
│  async def height(message, state):                                        │
│      ✓ Валидирует рост                                                    │
│      ✓ Получает язык пользователя из БД                                   │
│      ✓ Вызывает get_birthdate_calendar()  ────────────┐                  │
│      ✓ Устанавливает состояние REG.age_calendar       │                  │
│      ✓ Отправляет календарь пользователю              │                  │
└───────────────────────────────────────────────────────┼──────────────────┘
                                                        │
                          ┌─────────────────────────────┘
                          │
                          ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                UTILS LAYER (calendar_utils.py)                            │
│                                                                           │
│  class CalendarKeyboard:                                                  │
│      ✓ get_birthdate_calendar(lang)                                       │
│          └─> Создает календарь с ограничениями (10-100 лет)              │
│                                                                           │
│      ✓ create_calendar(year, month, context)                              │
│          └─> Генерирует InlineKeyboardMarkup                              │
│          └─> Рендерит сетку дней                                          │
│          └─> Добавляет навигацию ◀ ▶                                      │
│          └─> Блокирует недоступные даты                                   │
│                                                                           │
│      ✓ parse_callback(callback_data)                                      │
│          └─> Парсит действия: navigate, select, cancel, ignore           │
└───────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           TELEGRAM                                        │
│              Отображает календарь пользователю                            │
└────────────────────────────────┬─────────────────────────────────────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │                      │                      │
          ▼                      ▼                      ▼
    [◀ Предыдущий]        [День месяца]          [▶ Следующий]
          │                      │                      │
          └──────────────────────┴──────────────────────┘
                                 │
                    Callback Query (cal_birthdate_...)
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER (main.py)                           │
│                                                                           │
│  @dp.callback_query(F.data.startswith('cal_'), REG.age_calendar)         │
│  async def handle_calendar_callback(callback, state):                    │
│      1. Получает язык пользователя                                        │
│      2. Парсит callback_data ──────────────────────┐                     │
│      3. Обрабатывает действие:                     │                     │
│                                                     │                     │
│         ┌─ ignore    → Игнорирует                  │                     │
│         ├─ cancel    → Возврат к вводу роста       │                     │
│         ├─ navigate  → Генерирует новый календарь ─┼──┐                  │
│         └─ select    → Валидирует дату ────────────┼──┼──┐               │
│                                                     │  │  │               │
└─────────────────────────────────────────────────────┼──┼──┼───────────────┘
                                                      │  │  │
                    ┌─────────────────────────────────┘  │  │
                    │                                    │  │
                    ▼                                    │  │
┌──────────────────────────────────────────────────────┐│  │
│       UTILS LAYER (calendar_utils.py)                ││  │
│                                                       ││  │
│  ✓ parse_callback() → Возвращает (action, data)     ││  │
│  ✓ get_calendar_keyboard() → Новая клавиатура       ││  │
└──────────────────────────────────────────────────────┘│  │
                                                        │  │
                    ┌───────────────────────────────────┘  │
                    │                                      │
                    ▼                                      │
┌──────────────────────────────────────────────────────┐  │
│       UTILS LAYER (calendar_utils.py)                │  │
│                                                       │  │
│  ✓ create_calendar() → InlineKeyboardMarkup          │  │
│      - Обновленный месяц                             │  │
│      - Новая сетка дней                              │  │
└──────────────────────────────────────────────────────┘  │
                                                          │
                    ┌─────────────────────────────────────┘
                    │
                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│              DOMAIN LAYER (calendar_service.py)                           │
│                                                                           │
│  class CalendarService:                                                   │
│                                                                           │
│      ✓ validate_birthdate(date)                                           │
│          └─> Проверяет возраст (10-100 лет)                               │
│          └─> Проверяет, что дата не в будущем                             │
│          └─> Возвращает (is_valid, error_key)                             │
│                                                                           │
│      ✓ calculate_age(date)                                                │
│          └─> Вычисляет возраст на сегодня                                 │
│                                                                           │
│      ✓ format_date(date)                                                  │
│          └─> Форматирует как ДД-ММ-ГГГГ                                   │
│                                                                           │
│      ✓ get_localized_error_message(error_key, lang)                       │
│          └─> Возвращает сообщение об ошибке на нужном языке               │
│                                                                           │
│      ✓ get_date_confirmation_message(date, lang)                          │
│          └─> Форматирует подтверждение с возрастом                        │
└───────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
                        ┌────────┴────────┐
                        │                 │
                    ✅ ВАЛИДНО        ❌ ОШИБКА
                        │                 │
                        ▼                 ▼
        ┌───────────────────────┐   ┌──────────────────────────┐
        │ Сохранить дату        │   │ Показать alert с ошибкой │
        │ Показать подтверждение│   │ Остаться на календаре    │
        │ → Переход к REG.sex   │   └──────────────────────────┘
        └───────────────────────┘
```

## Состояния FSM

```
┌─────────────────────────────────────────────────────────────┐
│                    REGISTRATION FLOW                        │
└─────────────────────────────────────────────────────────────┘

  START
    ↓
  [Выбор языка]
    ↓
  [Privacy Policy]
    ↓
┌─────────────────┐
│   REG.height    │  ← Пользователь вводит рост
└────────┬────────┘
         ↓
┌─────────────────┐
│ REG.age_calendar│  ← 🆕 НОВОЕ СОСТОЯНИЕ! Календарь
└────────┬────────┘
         ↓
   ┌─────┴──────┐
   │            │
   ▼            ▼
[Навигация]  [Выбор даты]
   │            │
   │            ↓
   │       [Валидация]
   │            │
   │       ┌────┴────┐
   │       │         │
   ↓       ▼         ▼
[Новый   [OK]   [Ошибка]
 месяц]   ↓         ↓
   ↑      │    [Alert]
   └──────┘         ↓
                    └──> Остаться в REG.age_calendar
         │
         ↓
┌─────────────────┐
│    REG.sex      │  ← Выбор пола
└────────┬────────┘
         ↓
      [Далее...]
```

## Callback Data структура

```
                    cal_{context}_{action}_{params}
                         │         │         │
                         │         │         └─> Параметры (год, месяц, день)
                         │         └─────────> Действие
                         └───────────────────> Контекст (birthdate, etc.)

┌──────────────────────────────────────────────────────────────────┐
│                        ДЕЙСТВИЯ (actions)                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  prev        →  Предыдущий месяц                                │
│                 cal_birthdate_prev_2024_5                        │
│                      └─> Апрель 2024                             │
│                                                                  │
│  next        →  Следующий месяц                                 │
│                 cal_birthdate_next_2024_5                        │
│                      └─> Июнь 2024                               │
│                                                                  │
│  day         →  Выбор дня                                        │
│                 cal_birthdate_day_2000_5_15                      │
│                      └─> 15 мая 2000                             │
│                                                                  │
│  cancel      →  Отмена                                           │
│                 cal_birthdate_cancel                             │
│                      └─> Вернуться к REG.height                  │
│                                                                  │
│  ignore      →  Игнорировать                                     │
│                 cal_ignore                                       │
│                      └─> Заголовок, пустые ячейки                │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## Многоязычность

```
┌────────────────────────────────────────────────────────────────┐
│                  ПОДДЕРЖИВАЕМЫЕ ЯЗЫКИ                          │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  🇷🇺 Русский   (ru)                                            │
│      - Январь, Февраль, ... Декабрь                            │
│      - Пн, Вт, Ср, Чт, Пт, Сб, Вс                             │
│      - "❌ Отмена"                                             │
│                                                                │
│  🇬🇧 English   (en)                                            │
│      - January, February, ... December                         │
│      - Mo, Tu, We, Th, Fr, Sa, Su                             │
│      - "❌ Cancel"                                             │
│                                                                │
│  🇩🇪 Deutsch   (de)                                            │
│      - Januar, Februar, ... Dezember                           │
│      - Mo, Di, Mi, Do, Fr, Sa, So                             │
│      - "❌ Abbrechen"                                          │
│                                                                │
│  🇫🇷 Française (fr)                                            │
│      - Janvier, Février, ... Décembre                          │
│      - Lu, Ma, Me, Je, Ve, Sa, Di                             │
│      - "❌ Annuler"                                            │
│                                                                │
│  🇪🇸 Spanish   (es)                                            │
│      - Enero, Febrero, ... Diciembre                           │
│      - Lu, Ma, Mi, Ju, Vi, Sá, Do                             │
│      - "❌ Cancelar"                                           │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## Валидация

```
┌────────────────────────────────────────────────────────────────┐
│                  ПРАВИЛА ВАЛИДАЦИИ ДАТЫ                        │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  1. Минимальный возраст: 10 лет                                │
│     ├─ MAX_DATE = сегодня - 10 лет                            │
│     └─ Если дата > MAX_DATE → "too_young"                     │
│                                                                │
│  2. Максимальный возраст: 100 лет                              │
│     ├─ MIN_DATE = сегодня - 100 лет                           │
│     └─ Если дата < MIN_DATE → "too_old"                       │
│                                                                │
│  3. Дата не в будущем                                          │
│     └─ Если дата > сегодня → "future_date"                    │
│                                                                │
│  4. UI блокировка                                              │
│     └─ Недоступные даты показаны как "·15·"                   │
│                                                                │
└────────────────────────────────────────────────────────────────┘

ПРИМЕРЫ:

Сегодня: 08.11.2024

✅ ВАЛИДНЫЕ ДАТЫ:
   - 15.05.2000 (24 года)  ✓
   - 01.01.1995 (29 лет)   ✓
   - 08.11.2014 (10 лет)   ✓ Граница MIN_AGE

❌ НЕВАЛИДНЫЕ ДАТЫ:
   - 01.01.2020 (4 года)   ✗ too_young
   - 01.01.1900 (124 года) ✗ too_old  
   - 01.01.2030 (будущее)  ✗ future_date
```

## Кэширование (опционально)

```
┌────────────────────────────────────────────────────────────────┐
│                    CALENDAR CACHE                              │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Ключ: cal_{context}_{lang}_{year}_{month}                    │
│  Пример: cal_birthdate_ru_2000_5                              │
│                                                                │
│  Преимущества:                                                 │
│  ✓ Снижение нагрузки при навигации                            │
│  ✓ Быстрая генерация повторных календарей                     │
│  ✓ Меньше вычислений на сервере                               │
│                                                                │
│  Использование:                                                │
│                                                                │
│  key = calendar_cache.generate_key('ru', 2000, 5)             │
│  cached = calendar_cache.get(key)                             │
│                                                                │
│  if not cached:                                                │
│      keyboard = create_calendar(...)                           │
│      calendar_cache.set(key, keyboard)                        │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

**Легенда:**
- `┌─┐` - Компонент/Модуль
- `→` - Поток данных
- `↓` - Переход состояния
- `✓` - Функция/Метод
- `✅` - Успешная валидация
- `❌` - Ошибка валидации

